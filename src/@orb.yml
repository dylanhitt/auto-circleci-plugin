# CircleCI config for Auto Mobile Security Testing
# See https://docs.nowsecure.com/auto/integration-services/jenkins-integration/
# https://github.com/nowsecure/auto-circleci-plugin
version: 2.1
description: NowSecure AUTO provides fully automated, mobile appsec testing coverage
display:
  source_url: https://github.com/nowsecure/auto-circleci-plugin
  home_url: https://www.nowsecure.com/

executors:
  default:
    description: >
      Container with nowsecure-auto cli
    docker:
      - image: dylanhitt1/nowsecure-auto:<< parameters.tag >>
    parameters:
      tag:
        default: lts
        description: >
          The `dylanhitt1/nowsecure-auto` Docker image version tag.
          This tag is exposed for development use. It is suggested to
          not change the default.
        type: string

commands:
  mobile_security_test:
    description: Executes security test using NowSecure AUTO.
    parameters:
      url:
        description: url for nowsecure auto API
        type: string
        default: https://lab-api.nowsecure.com

      token:
        description: |
          API token, visit
          https://docs.nowsecure.com/auto/integration-services/jenkins-integration
          to generate token. The default is to read teh variable AUTO_TOKEN from
          the environment or context.
        type: string
        default: $AUTO_TOKEN

      group_id:
        description: |
          Specify group uuid if you belong to multiple groups. You can obtain the
          group id by hovering over the group name in the [Account & Management >
          Groups](https://lab.nowsecure.com/account/management/groups). The default
          is to read the variable AUTO_GROUP fromthe environment or context.
        type: string
        default: $AUTO_GROUP

      artifact_dir:
        description: |
          Specify artifacts-dir where security artifacts will be stored
        type: string
        default: "/tmp/workspace/nowsecure-auto-security-test"

      file:
        description: |
          Specify absolute path of mobile binary,
          you would need to attach workspace to this plugin step
        type: string

      wait:
        description: |
          Specify maximum time to wait (in minutes) for results,
          if you specify 0 then plugin will not wait for the results
        type: integer
        default: 30

      score:
        description: |
          Specify minimum score the app should get
          from security testing, if you specify 0 then score will
          not be evaulated otherwise build will be
          marked as failure if security score is below this number
        type: integer
        default: 50

      show_status_messages:
        description: |
          Specify flag to show status messages from automation testing
        type: boolean
        default: false

    steps:
      - run:
          command: >
            nowsecure-auto --url << parameters.url >> \
              --token << parameters.token >> \
              --artifact-dir << parameters.artifact_dir >> \
              --file << parameters.file >> \
              --group-id << parameters.group_id >> \
              --wait << parameters.wait >> \
              --score << parameters.score >> \
              --show-status-messages << parameters.show_status_messages >>
          no_output_timeout: 90m
