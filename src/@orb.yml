# CircleCI config for Auto Mobile Security Testing
# See https://docs.nowsecure.com/auto/integration-services/jenkins-integration/
# https://github.com/nowsecure/auto-circleci-plugin
version: 2.1
description: NowSecure AUTO provides fully automated, mobile appsec testing coverage
display:
  source_url: https://github.com/nowsecure/auto-circleci-plugin
  home_url: https://www.nowsecure.com/
commands:
  mobile_security_test:
    description: Executes security test using NowSecure AUTO.
    parameters:
      url:
        description: url for nowsecure auto API
        type: string
        default: https://lab-api.nowsecure.com

      token:
        description: |
          API token, visit
          https://docs.nowsecure.com/auto/integration-services/jenkins-integration
          to generate token
        type: string
        default: $TOKEN

      group:
        description: Specify group if you belong to multiple groups
        type: string
        default: $GROUP

      artifact_dir:
        description: |
          Specify artifacts-dir where security artifacts will be stored
        type: string
        default: "/tmp/workspace/nowsecure-auto-security-test"

      file:
        description: |
          Specify absolute path of mobile binary,
          you would need to attach workspace to this plugin step
        type: string

      wait:
        description: |
          Specify maximum time to wait for results,
          if you specify 0 then plugin will not wait for the results
        type: string
        default: "30"

      score:
        description: |
          Specify minimum score the app should get
          from security testing, if you specify 0 then score will
          not be evaulated otherwise build will be
          marked as failure if security score is below this number
        type: string
        default: "50"

      show_status_messages:
        description: |
          Specify flag to show status messages from automation testing
        type: string
        default: "false"

    steps:
      - run:
          command: >
            nowsecure-auto --url << parameters.url >> \
              --token << parameters.token >> \
              --artifact-dir << parameters.artifact_dir >> \
              --file << parameters.file >> \
              --group << parameters.group >> \
              --wait << parameters.wait >> \
              --score << parameters.score >> \
              --show-status-messages << parameters.show_status_messages >>
          no_output_timeout: 90m
